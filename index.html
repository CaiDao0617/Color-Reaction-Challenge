<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>色彩反應挑戰 - Google 登入</title>
    <!-- 引入 Tailwind CSS 確保響應式和美觀的設計 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 設置全局字體和夢核漸變背景 */
        body {
            font-family: 'Inter', sans-serif;
            /* 粉藍漸變 (Dreamcore Style) */
            background: linear-gradient(135deg, #a8aaff, #ffafcc); 
            background-attachment: fixed; /* 確保漸變覆蓋整個頁面 */
        }
        /* 主容器，帶有半透明效果和柔和邊緣 */
        #game-container {
            backdrop-filter: blur(5px);
            background-color: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.4);
        }
        /* 自定義按鈕樣式 */
        .color-button {
            transition: transform 0.15s ease-out, box-shadow 0.15s ease-out;
            touch-action: manipulation;
            box-shadow: 0 6px 10px -3px rgba(100, 100, 150, 0.2), 0 2px 4px -2px rgba(100, 100, 150, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.5); 
        }
        .color-button:active {
            transform: scale(0.96);
            box-shadow: 0 2px 4px 0 rgba(100, 100, 150, 0.1);
        }
        @keyframes pulse-correct {
            0% { box-shadow: 0 0 0 0 #b3e0e6; } 
            70% { box-shadow: 0 0 0 10px rgba(179, 224, 230, 0); }
            100% { box-shadow: 0 0 0 0 rgba(179, 224, 230, 0); }
        }
        @keyframes pulse-wrong {
            0% { transform: translateX(0); }
            20% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            60% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
            100% { transform: translateX(0); }
        }
        .correct-flash { animation: pulse-correct 0.5s ease-out; }
        .wrong-shake { animation: pulse-wrong 0.4s ease-out; }

        /* Google 登入按鈕特殊樣式 */
        #google-sign-in-button {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #4285F4;
            color: white;
            font-weight: bold;
            padding: 1rem;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- 主遊戲容器 -->
    <div id="game-container" class="w-full max-w-md rounded-3xl p-6 shadow-2xl space-y-6">
        
        <!-- 遊戲名 -->
        <h1 class="text-4xl font-extrabold text-center text-purple-700">色彩反應挑戰</h1>

        <!-- 遊戲數據面板 -->
        <div class="flex justify-between items-center text-xl font-bold p-3 bg-fuchsia-50 rounded-xl border border-fuchsia-200">
            <div class="text-purple-600 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-pink-500" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.004 8.72c-.784-.57-.381-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                得分: <span id="score" class="ml-1">0</span>
            </div>
            <div class="text-pink-600 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-1 text-pink-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg>
                生命: <span id="lives" class="ml-1">3</span>
            </div>
        </div>

        <!-- 倒數計時器條 (只在遊戲中顯示) -->
        <div id="timer-bar-container" class="h-3 bg-gray-200 rounded-full overflow-hidden border border-gray-300 hidden">
            <div id="timer-bar-fill" class="h-full bg-purple-400 rounded-full transition-colors duration-500 ease-linear" style="width: 100%;"></div>
        </div>

        <!-- 暱稱輸入區 / 遊戲主體 / 排行榜區 (根據狀態切換) -->
        
        <!-- 暱稱/登入設定區 (初始顯示) -->
        <div id="nickname-setup-area" class="space-y-4">
            <div id="auth-status-message" class="text-center text-lg font-bold text-gray-700">
                請先登入 Google 帳號以記錄您的排名。
            </div>
            
            <button id="google-sign-in-button" class="w-full py-3 rounded-2xl text-xl color-button" onclick="signInWithGoogle()">
                <svg class="w-6 h-6 mr-3" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M43.611 20.083H42V20H24V28H35.611C34.793 32.756 31.336 36.19 24 36.19C18.665 36.19 13.914 31.97 13.914 24.364C13.914 16.758 18.665 12.538 24 12.538C27.094 12.538 29.842 13.882 31.745 15.694L38.487 9.072C34.619 5.372 29.626 3.447 24 3.447C11.954 3.447 1.889 13.435 1.889 24.364C1.889 35.293 11.954 45.281 24 45.281C35.539 45.281 44.027 36.216 44.027 24.04C44.027 22.421 43.834 21.144 43.611 20.083Z" fill="#fff"/></svg>
                使用 Google 帳號登入
            </button>

            <!-- 暱稱輸入區 (登入後才會顯示) -->
            <div id="nickname-input-group" class="hidden space-y-4">
                <input type="text" id="nickname-input" placeholder="輸入您的遊戲暱稱" class="w-full p-3 border-2 border-purple-300 rounded-xl text-center text-xl focus:outline-none focus:border-pink-500 transition shadow-inner" maxlength="10">
                <p id="nickname-error" class="text-red-500 text-sm text-center font-bold hidden">此暱稱已被使用，請換一個。</p>
                <button id="nickname-start-button" class="w-full py-4 bg-purple-500 hover:bg-purple-600 text-white font-extrabold rounded-2xl text-xl color-button" onclick="handleNicknameSubmit()">
                    檢查暱稱並開始挑戰
                </button>
            </div>
        </div>

        <!-- 遊戲主體區域 (遊戲中顯示) -->
        <div id="game-main-area" class="hidden">
            <div class="text-center">
                <!-- 副標題：修復了空格並加上粗體紅字 -->
                <p class="text-gray-700 font-medium mb-3 text-lg">
                    點擊<strong class="text-red-500">背景色</strong>與上方<strong class="text-red-500">文字一致</strong>的方塊：
                </p>
                <!-- 目標文字顯示框 -->
                <div id="target-word-display" class="p-4 text-5xl font-extrabold rounded-2xl shadow-lg border-4 border-purple-300 transition-all duration-150 select-none" style="min-height: 100px; display: flex; align-items: center; justify-content: center; background-color: #fcfcfc;">
                    <!-- 挑戰文字會在遊戲開始時載入 -->
                </div>
            </div>
            <!-- 顏色選項按鈕網格 -->
            <div id="color-options-grid" class="grid grid-cols-2 gap-4">
                <!-- 顏色按鈕將由 JavaScript 生成 -->
            </div>
        </div>

        <!-- 排行榜顯示區域 (點擊按鈕後顯示) -->
        <div id="leaderboard-area" class="hidden space-y-4">
            <h2 class="text-2xl font-bold text-purple-600 text-center">全服高分挑戰者</h2>
            <div id="leaderboard-content-wrapper" class="space-y-4">
                <ul id="leaderboard-list" class="bg-gray-50 p-4 rounded-xl border border-gray-200 divide-y divide-gray-200 shadow-inner">
                    <!-- 排行榜項目將由 JavaScript 載入 -->
                    <li class="py-2 text-center text-gray-500">載入中...</li>
                </ul>
                <!-- 個人排名將顯示在這裡 -->
                <div id="personal-rank-display"></div>
            </div>
            
            <button class="w-full py-3 bg-pink-500 hover:bg-pink-600 text-white font-bold rounded-xl text-lg color-button" onclick="showNicknameInput()">
                返回首頁/開始新遊戲
            </button>
        </div>

    </div>

    <!-- 遊戲結束模態視窗 -->
    <div id="game-over-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-70 hidden transition-opacity duration-300">
        <div id="modal-content" class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center space-y-6 transform transition duration-500 scale-100 border-4 border-pink-300">
            <h2 id="modal-title" class="text-4xl font-extrabold text-purple-700">挑戰結束</h2>
            <p class="text-xl text-gray-700">最終得分: <span id="final-score" class="font-bold text-pink-600">0</span></p>
            <button class="w-full py-3 bg-pink-500 hover:bg-pink-600 text-white font-bold rounded-xl text-lg color-button" onclick="closeModal(); showNicknameInput()">
                再玩一次
            </button>
            <button class="w-full py-3 bg-purple-500 hover:bg-purple-600 text-white font-bold rounded-xl text-lg color-button" onclick="closeModal(); showLeaderboard()">
                查看全服排名
            </button>
        </div>
    </div>
    
    <!-- Firebase SDKs - 已更新為 12.6.0 並包含必要模組 -->
    <script type="module">
        // 導入 Google 登入所需的新模組
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, getDocs, collection, query, where, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        
        setLogLevel('debug');

        // ************************************************************************************************************************************
        // ** 【您的 Firebase 配置】 - 包含您最新提供的 API 金鑰 **
        // ************************************************************************************************************************************
        const YOUR_REAL_FIREBASE_CONFIG = {
            // ** 這是您提供的最新金鑰: AIzaSyBXAq0SD4wL8HZhnc0_56h4eeOYuKoSPOs **
            apiKey: "AIzaSyBXAq0SD4wL8HZhnc0_56h4eeOYuKoSPOs", 
            authDomain: "color-reaction-game.firebaseapp.com",
            projectId: "color-reaction-game",
            storageBucket: "color-reaction-game.firebasestorage.app",
            messagingSenderId: "572512107426",
            appId: "1:572512107426:web:7c092c4d7a038c11ca10fb",
            measurementId: "G-6GH32H335E"
        };
        // ************************************************************************************************************************************
        
        
        // --- 全局 Firebase 變數 ---
        const appId = YOUR_REAL_FIREBASE_CONFIG.projectId;
        const firebaseConfig = YOUR_REAL_FIREBASE_CONFIG;

        let app, db, auth;
        window.userId = null;
        window.userNickname = null;
        window.isAuthReady = false; // 追蹤登入狀態是否檢查完畢

        // --- DOM 元素引用 ---
        const nicknameInput = document.getElementById('nickname-input');
        const nicknameInputGroup = document.getElementById('nickname-input-group');
        const googleSignInButton = document.getElementById('google-sign-in-button');
        const nicknameError = document.getElementById('nickname-error');
        const nicknameStartButton = document.getElementById('nickname-start-button');
        const leaderboardList = document.getElementById('leaderboard-list');
        const personalRankDisplay = document.getElementById('personal-rank-display');
        const authStatusMessage = document.getElementById('auth-status-message');


        /**
         * 處理 Google 登入流程
         */
        window.signInWithGoogle = async function() {
            const provider = new GoogleAuthProvider();
            try {
                // 使用彈出視窗登入
                await signInWithPopup(auth, provider);
                // 登入成功後，onAuthStateChanged 會處理後續動作
            } catch (error) {
                console.error("Google 登入失敗:", error);
                
                // --- 修正錯誤診斷邏輯 ---
                let errorMessage = "Google 登入失敗，請檢查彈出視窗是否被阻擋。";

                if (error.message && error.message.includes('auth/requests-from-referer')) {
                    // 偵測到 API 金鑰的網站限制錯誤
                    const blockedUrlMatch = error.message.match(/https:\/\/[^)]+/); 
                    const blockedDomain = blockedUrlMatch ? blockedUrlMatch[0].replace(/-are-blocked./, '') : '您的執行環境網址';

                    errorMessage = `【API 限制錯誤】請在 Google Cloud Console -> API 限制中，新增您的執行網址: ${blockedDomain}/*`;
                } else if (error.code && error.code === 'auth/network-request-failed') {
                    // 網路連線錯誤 (例如 Firebase 服務本身被拒絕)
                    errorMessage = "Firebase 服務連線失敗，請檢查 Firebase 安全規則或網路連線。";
                }

                nicknameError.textContent = errorMessage;
                nicknameError.classList.remove('hidden');
                // --- 修正錯誤診斷邏輯結束 ---
            }
        }
        
        /**
         * 檢查暱稱是否已被佔用 (需要 Firebase 連線)
         */
        async function checkNicknameExists(nickname) {
            try {
                // 我們只檢查暱稱是否被【其他】用戶使用
                const nicknamesRef = collection(db, `artifacts/${appId}/public/data/nicknames`);
                const q = query(nicknamesRef, where("nickname", "==", nickname), limit(1));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) { return false; }

                const existingDoc = querySnapshot.docs[0];
                // 如果找到的暱稱文件 ID 與當前用戶 ID 相同，則視為可用
                if (existingDoc.id === window.userId) { return false; }
                
                return true; 
            } catch (error) {
                console.error("檢查暱稱連線失敗，可能是規則或連線問題:", error);
                return true; // 預防性地拒絕，以防資料庫寫入失敗
            }
        }

        // 提交暱稱並開始遊戲
        window.handleNicknameSubmit = async function() {
            if (!window.userId) return; // 必須登入

            const inputNickname = nicknameInput.value.trim();
            if (inputNickname.length < 2 || inputNickname.length > 10) {
                nicknameError.textContent = "暱稱長度需在 2 到 10 個字元之間。";
                nicknameError.classList.remove('hidden');
                return;
            }
            nicknameError.classList.add('hidden');
            nicknameStartButton.disabled = true;
            nicknameStartButton.textContent = "檢查暱稱中...";

            try {
                if (await checkNicknameExists(inputNickname)) {
                    nicknameError.textContent = "此暱稱已被其他玩家使用，請換一個。";
                    nicknameError.classList.remove('hidden');
                    return;
                }

                // 儲存暱稱，文件 ID 使用用戶的真實 UID
                const userDocRef = doc(db, `artifacts/${appId}/public/data/nicknames`, window.userId);
                await setDoc(userDocRef, {
                    nickname: inputNickname,
                    userId: window.userId,
                    email: auth.currentUser.email // 可選：儲存電子郵件以便管理
                }, { merge: true });

                window.userNickname = inputNickname;
                window.startGame(); 
            } catch (error) {
                console.error("處理暱稱時發生錯誤:", error);
                nicknameError.textContent = "資料庫讀寫錯誤，請檢查安全規則。";
                nicknameError.classList.remove('hidden');
            } finally {
                nicknameStartButton.textContent = "檢查暱稱並開始挑戰";
                nicknameStartButton.disabled = false;
            }
        }

        // 顯示排行榜
        window.showLeaderboard = async function() {
            if (!window.isAuthReady) return;

            window.showArea('leaderboard-area');
            leaderboardList.innerHTML = '<li class="py-2 text-center text-purple-500 font-bold">排行榜載入中...</li>';
            personalRankDisplay.innerHTML = '';

            try {
                const scoresRef = collection(db, `artifacts/${appId}/public/data/scores`);
                
                // Fetch ALL documents for client-side processing (避免 Firestore 索引問題)
                const qAllScores = query(scoresRef); 
                const allScoresSnapshot = await getDocs(qAllScores);

                // ... (排行榜計算邏輯與之前版本相同，在客戶端處理) ...
                let userHighestScores = {};
                allScoresSnapshot.forEach(doc => {
                    const data = doc.data();
                    const userId = data.userId;
                    const score = data.score || 0;
                    const nickname = data.nickname || '匿名玩家';

                    if (!userHighestScores[userId] || score > userHighestScores[userId].score) {
                        userHighestScores[userId] = { userId, score, nickname };
                    }
                });

                let rankedUsers = Object.values(userHighestScores);
                rankedUsers.sort((a, b) => b.score - a.score);

                const top10Scores = rankedUsers.slice(0, 10);
                const userRankedEntry = rankedUsers.find(entry => entry.userId === window.userId);

                let html = '';
                let isUserInTop10 = false;
                
                if (top10Scores.length === 0) {
                    html = '<li class="py-2 text-center text-gray-500">目前沒有排名記錄。</li>';
                } else {
                    top10Scores.forEach((data, index) => {
                        const rank = index + 1;
                        let currentRank = rank;
                        
                        if (index > 0 && data.score === top10Scores[index - 1].score) { currentRank = index; }
                        
                        const isCurrentUser = data.userId === window.userId;
                        if (isCurrentUser) { isUserInTop10 = true; }

                        const rankClass = currentRank === 1 ? 'text-yellow-600 font-extrabold' : currentRank <= 3 ? 'text-pink-500 font-bold' : 'text-gray-700';

                        html += `
                            <li class="py-3 flex justify-between items-center text-lg ${isCurrentUser ? 'bg-green-100 rounded-lg px-2 shadow-md' : ''}">
                                <span class="${rankClass}">No.${currentRank}</span>
                                <span class="text-purple-600 font-medium">${data.nickname}</span>
                                <span class="text-indigo-700 font-extrabold">${data.score} 分</span>
                            </li>
                        `;
                    });
                }
                
                leaderboardList.innerHTML = html;

                // 5. 顯示未進榜的個人排名 
                if (userRankedEntry) {
                    let globalRank = rankedUsers.findIndex(entry => entry.userId === window.userId) + 1;
                    let userBestScore = userRankedEntry.score;

                    let finalGlobalRank = globalRank;
                    for (let i = globalRank - 2; i >= 0; i--) {
                        if (rankedUsers[i].score === userBestScore) { finalGlobalRank = i + 1; } else { break; }
                    }

                    if (!isUserInTop10 || finalGlobalRank > 10) {
                        personalRankDisplay.innerHTML = `
                            <div class="p-3 bg-fuchsia-100 rounded-xl border-2 border-fuchsia-300 text-center shadow-inner mt-4">
                                <p class="text-xl font-bold text-pink-600 mb-1">您的最佳成績:</p>
                                <p class="text-lg text-gray-700">排名: <strong class="text-purple-700">No.${finalGlobalRank}</strong></p>
                                <p class="text-lg text-gray-700">得分: <strong class="text-purple-700">${userBestScore} 分</strong></p>
                            </div>
                        `;
                    }
                } else {
                    personalRankDisplay.innerHTML = `<p class="text-center text-sm text-gray-500 mt-2">您尚未完成任何挑戰，快去挑戰吧！</p>`;
                }

            } catch (error) {
                console.error("載入排行榜時發生致命錯誤:", error);
                leaderboardList.innerHTML = '<li class="py-2 text-center text-red-500">載入失敗，請檢查連線或 Firebase 安全規則。</li>';
                personalRankDisplay.innerHTML = '';
            }
        }

        // 記錄最終得分
        window.saveScore = async function(finalScore) {
            if (!window.userId || !window.userNickname || finalScore <= 0) return;

            try {
                const scoresRef = collection(db, `artifacts/${appId}/public/data/scores`);
                await setDoc(doc(scoresRef), {
                    userId: window.userId,
                    nickname: window.userNickname,
                    score: finalScore,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error("儲存得分時發生錯誤:", error);
            }
        }
        
        // --- 登入狀態處理 ---
        function updateAuthUI(user) {
            if (user) {
                window.userId = user.uid;
                authStatusMessage.textContent = `已登入為：${user.displayName || user.email}`;
                googleSignInButton.classList.add('hidden');
                nicknameInputGroup.classList.remove('hidden');
                
                loadUserNickname(user.uid);
            } else {
                window.userId = null;
                window.userNickname = null;
                authStatusMessage.textContent = '請先登入 Google 帳號以記錄您的排名。';
                googleSignInButton.classList.remove('hidden');
                nicknameInputGroup.classList.add('hidden');
                document.getElementById('nickname-input').value = '';
                document.getElementById('nickname-start-button').textContent = '檢查暱稱並開始挑戰';
            }
        }

        async function loadUserNickname(uid) {
            try {
                const userDocRef = doc(db, `artifacts/${appId}/public/data/nicknames`, uid);
                const docSnap = await getDoc(userDocRef); 
                
                if (docSnap.exists()) {
                    window.userNickname = docSnap.data().nickname;
                    nicknameInput.value = window.userNickname; 
                    nicknameStartButton.textContent = `以 ${window.userNickname} 開始挑戰！`;
                } else {
                    window.userNickname = null;
                    nicknameInput.value = '';
                    nicknameStartButton.textContent = "設定暱稱並開始挑戰";
                }
            } catch (error) {
                 console.error("載入暱稱失敗:", error);
                 nicknameError.textContent = "連線失敗，無法讀取暱稱。";
                 nicknameError.classList.remove('hidden');
            }
        }

        // Firebase 初始化
        window.addEventListener('load', async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 設置 Auth 狀態監聽器
                onAuthStateChanged(auth, (user) => {
                    updateAuthUI(user);
                    window.isAuthReady = true;
                });
                
            } catch (error) {
                console.error("Firebase 初始化失敗:", error);
                const errorMessage = document.getElementById('auth-status-message');
                errorMessage.textContent = "初始化失敗，請檢查瀏覽器快取或網路連線。";
            }
        });

    </script>
    
    <script>
        // --- 遊戲邏輯變數 (與 Firebase 無關) ---
        let score = 0;
        let lives = 3;
        let timerInterval;
        let timeLeft;
        const TIME_LIMIT = 1.8;
        const LIVES_MAX = 3;

        const COLORS = [
            { name: "紅色", hex: "#dc2626" },  // Red-600
            { name: "橙色", hex: "#f97316" },  // Orange-600
            { name: "黃色", hex: "#eab308" },  // Yellow-600
            { name: "綠色", hex: "#16a34a" },  // Green-600
            { name: "藍色", hex: "#2563eb" },  // Blue-600
            { name: "紫色", hex: "#9333ea" }   // Violet-600
        ];
        
        // --- DOM 元素引用 (與遊戲邏輯相關) ---
        const scoreDisplay = document.getElementById('score');
        const livesDisplay = document.getElementById('lives');
        const targetWordDisplay = document.getElementById('target-word-display');
        const colorOptionsGrid = document.getElementById('color-options-grid');
        const gameOverModal = document.getElementById('game-over-modal');
        const finalScoreDisplay = document.getElementById('final-score');
        const timerBarFill = document.getElementById('timer-bar-fill');
        const timerBarContainer = document.getElementById('timer-bar-container');
        const nicknameSetupArea = document.getElementById('nickname-setup-area');
        const gameMainArea = document.getElementById('game-main-area');
        const leaderboardArea = document.getElementById('leaderboard-area');
        
        // --- 遊戲核心函數 ---
        window.showArea = function(areaId) {
            // ... (區域顯示邏輯) ...
            document.getElementById('nickname-setup-area').classList.add('hidden');
            document.getElementById('game-main-area').classList.add('hidden');
            document.getElementById('leaderboard-area').classList.add('hidden');
            document.getElementById('timer-bar-container').classList.add('hidden');

            if (areaId === 'game-main-area') {
                document.getElementById('game-main-area').classList.remove('hidden');
                document.getElementById('timer-bar-container').classList.remove('hidden');
            } else if (areaId === 'nickname-setup-area') {
                document.getElementById('nickname-setup-area').classList.remove('hidden');
            } else if (areaId === 'leaderboard-area') {
                document.getElementById('leaderboard-area').classList.remove('hidden');
            }
        }
        
        window.showNicknameInput = function() {
            window.showArea('nickname-setup-area');
        }

        function getRandomColor() { return COLORS[Math.floor(Math.random() * COLORS.length)]; }
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        window.startGame = function() {
            if (!window.userId || !window.userNickname) {
                // 如果未登入或未設定暱稱，回到登入/暱稱設定介面
                window.showNicknameInput();
                return;
            }

            score = 0;
            lives = LIVES_MAX;
            updateDisplay();
            window.showArea('game-main-area');
            gameOverModal.classList.add('hidden');
            targetWordDisplay.classList.remove('correct-flash', 'wrong-shake');
            nextRound();
        }

        function gameOver() {
            clearInterval(timerInterval);
            const finalScore = score;
            finalScoreDisplay.textContent = finalScore;
            
            document.getElementById('modal-title').textContent = (finalScore > 0) ? "挑戰成功！" : "遊戲結束！";
            gameOverModal.classList.remove('hidden');
            
            colorOptionsGrid.innerHTML = '';
            targetWordDisplay.textContent = '挑戰結束';
            targetWordDisplay.style.color = '#7c3aed';
            targetWordDisplay.style.backgroundColor = '#f3e8ff';

            window.saveScore(finalScore);
        }

        function updateDisplay() {
            scoreDisplay.textContent = score;
            livesDisplay.textContent = lives;
        }

        window.closeModal = function() {
            gameOverModal.classList.add('hidden');
        }

        function nextRound() {
            if (lives <= 0) {
                gameOver();
                return;
            }
            
            targetWordDisplay.classList.remove('correct-flash', 'wrong-shake');
            const targetColor = getRandomColor();
            targetWordDisplay.textContent = targetColor.name;
            let randomTextColor = getRandomColor(); 
            while (randomTextColor.hex === targetColor.hex) { randomTextColor = getRandomColor(); }
            targetWordDisplay.style.color = randomTextColor.hex; 
            targetWordDisplay.style.backgroundColor = '#fcfcfc';

            let optionBackgroundColors = [];
            optionBackgroundColors.push(targetColor.hex);
            
            const incorrectColors = COLORS.filter(c => c.hex !== targetColor.hex);
            let shuffledIncorrect = shuffleArray([...incorrectColors]);

            let uniqueIncorrect = [];
            for (let i = 0; i < 3 && i < shuffledIncorrect.length; i++) {
                if (!uniqueIncorrect.includes(shuffledIncorrect[i].hex)) { uniqueIncorrect.push(shuffledIncorrect[i].hex); }
            }
            optionBackgroundColors.push(...uniqueIncorrect.slice(0, 3));
            
            while (optionBackgroundColors.length < 4) { optionBackgroundColors.push(uniqueIncorrect[0] || getRandomColor().hex); }

            optionBackgroundColors = shuffleArray(optionBackgroundColors);
            colorOptionsGrid.innerHTML = '';
            
            optionBackgroundColors.slice(0, 4).forEach(bgColor => {
                const optionText = getRandomColor().name; 
                const isCorrect = (bgColor === targetColor.hex);

                const r = parseInt(bgColor.substring(1, 3), 16);
                const g = parseInt(bgColor.substring(3, 5), 16);
                const b = parseInt(bgColor.substring(5, 7), 16);
                const luminosity = (0.2126 * r + 0.7152 * g + 0.0722 * b); 
                const buttonTextColor = luminosity > 186 ? '#1f2937' : '#ffffff';

                const button = document.createElement('button');
                button.className = `color-button w-full h-28 text-2xl font-black rounded-xl select-none`;
                button.style.backgroundColor = bgColor;
                button.style.color = buttonTextColor;
                button.textContent = optionText;

                button.dataset.isCorrect = isCorrect.toString();
                button.addEventListener('click', () => handleGuess(isCorrect));
                colorOptionsGrid.appendChild(button);
            });

            startTimer();
        }

        function startTimer() {
            clearInterval(timerInterval);
            timeLeft = TIME_LIMIT;
            const startTime = Date.now();
            const totalDurationMs = TIME_LIMIT * 1000;
            timerBarFill.style.width = '100%';
            timerBarFill.className = 'h-full rounded-full transition-colors duration-500 ease-linear bg-purple-400';

            const tick = () => {
                const elapsed = Date.now() - startTime;
                timeLeft = TIME_LIMIT - (elapsed / 1000);

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleGuess(false, true);
                } else {
                    const percentage = (timeLeft / TIME_LIMIT) * 100;
                    timerBarFill.style.width = `${percentage}%`;

                    if (percentage < 30) {
                        timerBarFill.classList.remove('bg-purple-400', 'bg-pink-400');
                        timerBarFill.classList.add('bg-pink-500');
                    } else if (percentage < 60) {
                        timerBarFill.classList.remove('bg-purple-400', 'bg-pink-500');
                        timerBarFill.classList.add('bg-pink-400');
                    } else {
                        timerBarFill.classList.add('bg-purple-400');
                    }
                }
            };
            
            timerInterval = setInterval(tick, 50);
        }

        function handleGuess(isCorrect, isTimeout = false) {
            clearInterval(timerInterval);

            if (isCorrect) {
                score++;
                targetWordDisplay.classList.add('correct-flash');
                targetWordDisplay.style.borderColor = '#96d1c7';
            } else {
                lives--;
                targetWordDisplay.classList.add('wrong-shake');
                targetWordDisplay.style.borderColor = '#ff69b4';
            }

            updateDisplay();
            colorOptionsGrid.style.pointerEvents = 'none';

            if (lives <= 0) {
                setTimeout(gameOver, 500);
            } else {
                setTimeout(() => {
                    colorOptionsGrid.style.pointerEvents = 'auto';
                    targetWordDisplay.style.borderColor = '#a8aaff';
                    nextRound();
                }, isTimeout ? 0 : 350); 
            }
        }

    </script>
</body>
</html>